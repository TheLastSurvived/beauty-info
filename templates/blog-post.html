<!-- templates/blog-post.html -->
{% extends "base.html" %} {% block content %}
<!-- Контент страницы записи блога -->
<div class="container mt-5 pt-4">
  <!-- Хлебные крошки -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Главная</a></li>
      <li class="breadcrumb-item"><a href="/blog">Блог</a></li>
      {% if post.category %}
      <li class="breadcrumb-item">
        <a href="/blog?category={{ post.category|urlencode }}">{{ post.category }}</a>
      </li>
      {% endif %}
      <li class="breadcrumb-item active" aria-current="page">
        {{ post.title|truncate(30) }}
      </li>
    </ol>
  </nav>

  <div class="row">
    <!-- Основной контент -->
    <div class="col-lg-8 mx-auto">
      <!-- Заголовок статьи -->
      <div class="post-header mb-4">
        <h1 class="post-title mb-3">{{ post.title }}</h1>

        <div class="post-meta mb-3">
          <span class="me-4"><i class="bi bi-calendar me-1"></i> {{ post.created_at.strftime('%d %B %Y') }}</span>
          <span class="me-4"><i class="bi bi-eye me-1"></i> {{ post.views_count }} просмотров</span>
          {% if post.author %}
          <span><i class="bi bi-person me-1"></i> {{ post.author }}</span>
          {% endif %}
        </div>

        {% if post.category %}
        <div class="post-category mb-4">
          <a href="/blog?category={{ post.category|urlencode }}" class="badge bg-beauty text-decoration-none">
            {{ post.category }}
          </a>
        </div>
        {% endif %}
      </div>

      <!-- Изображение статьи -->
      {% if post.image_url %}
      <div class="post-image mb-5">
        <img src="{{ post.image_url }}" alt="{{ post.title }}" class="img-fluid rounded" />
      </div>
      {% endif %}

      <!-- Содержимое статьи -->
      <div class="post-content mb-5">
        {% if post.excerpt %}
        <div class="lead mb-4">
          {{ post.excerpt }}
        </div>
        {% endif %}
        
        {{ post.content|safe }}
      </div>

      <!-- Теги -->
      {% if tags %}
      <div class="post-tags mb-5">
        <p class="mb-3"><strong><i class="bi bi-tags me-2"></i>Теги:</strong></p>
        <div>
          {% for tag in tags %}
          <a href="/blog?tag={{ tag.name|urlencode }}" class="tag me-2 mb-2">{{ tag.name }}</a>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Социальные кнопки -->
      <div class="social-share mb-5">
        <h6 class="mb-3"><i class="bi bi-share me-2"></i>Поделиться:</h6>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-outline-secondary btn-sm" onclick="shareToFacebook()">
            <i class="bi bi-facebook me-1"></i> Facebook
          </button>
          <button class="btn btn-outline-secondary btn-sm" onclick="shareToVK()">
            <i class="bi bi-vk me-1"></i> ВКонтакте
          </button>
          <button class="btn btn-outline-secondary btn-sm" onclick="shareToTelegram()">
            <i class="bi bi-telegram me-1"></i> Telegram
          </button>
          <button class="btn btn-outline-secondary btn-sm" onclick="copyLink()">
            <i class="bi bi-link me-1"></i> Копировать ссылку
          </button>
        </div>
      </div>

      <!-- Навигация по статьям -->
      {% if similar_posts %}
      <div class="similar-posts mb-5">
        <h4 class="mb-4"><i class="bi bi-bookmarks me-2"></i>Похожие статьи</h4>
        <div class="row">
          {% for similar_post in similar_posts %}
          <div class="col-md-6 mb-4">
            <div class="card h-100 border-0 shadow-sm">
              {% if similar_post.image_url %}
              <img src="{{ similar_post.image_url }}" class="card-img-top" alt="{{ similar_post.title }}" style="height: 180px; object-fit: cover;">
              {% endif %}
              <div class="card-body">
                <h6 class="card-title">{{ similar_post.title }}</h6>
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <small class="text-muted">{{ similar_post.created_at.strftime('%d.%m.%Y') }}</small>
                  <a href="/blog/{{ similar_post.slug }}" class="btn btn-beauty btn-sm">Читать</a>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Комментарии -->
      <div id="comments" class="comments-section mb-5">
        <h4 class="mb-4">
          <i class="bi bi-chat-text me-2"></i>Комментарии 
          <span class="badge bg-secondary ms-2">{{ comments|length }}</span>
        </h4>
        
        {% if comments %}
        <div class="comments-list mb-4">
          {% for comment in comments %}
          {% if comment.is_approved %}
          <div class="comment mb-3 pb-3 border-bottom">
            <div class="comment-header d-flex justify-content-between mb-2">
              <div>
                <strong>{{ comment.author_name }}</strong>
                {% if comment.author_email %}
                <small class="text-muted ms-2">{{ comment.author_email }}</small>
                {% endif %}
              </div>
              <small class="text-muted">{{ comment.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
            </div>
            <div class="comment-body">
              {{ comment.content|replace('\n', '<br>')|safe }}
            </div>
          </div>
          {% endif %}
          {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          Пока нет комментариев. Будьте первым!
        </div>
        {% endif %}

        <!-- Форма добавления комментария -->
        <div class="comment-form mt-5">
          <h5 class="mb-3"><i class="bi bi-pencil-square me-2"></i>Добавить комментарий</h5>
          <form method="post" action="/blog/{{ post.slug }}/comment" class="needs-validation" novalidate>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="author_name" class="form-label">Имя *</label>
                <input type="text" class="form-control" id="author_name" name="author_name" required>
                <div class="invalid-feedback">
                  Пожалуйста, введите ваше имя.
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="author_email" class="form-label">Email (необязательно)</label>
                <input type="email" class="form-control" id="author_email" name="author_email">
                <div class="invalid-feedback">
                  Пожалуйста, введите корректный email.
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="content" class="form-label">Комментарий *</label>
              <textarea class="form-control" id="content" name="content" rows="4" required></textarea>
              <div class="invalid-feedback">
                Пожалуйста, напишите комментарий.
              </div>
              <div class="form-text">
                Ваш комментарий будет опубликован после проверки модератором.
              </div>
            </div>
            <button type="submit" class="btn btn-beauty">
              <i class="bi bi-send me-2"></i>Отправить комментарий
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Обработка кликов по тегам
    document.querySelectorAll(".post-tags .tag").forEach((tag) => {
      tag.addEventListener("click", function (e) {
        e.preventDefault();
        const tagName = this.textContent;
        window.location.href = `/blog?tag=${encodeURIComponent(tagName)}`;
      });
    });

    // Валидация формы комментария
    const form = document.querySelector('.needs-validation');
    if (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    }

    // Кнопка "Копировать ссылку"
    window.copyLink = function() {
      const url = window.location.href;
      navigator.clipboard.writeText(url).then(() => {
        alert('Ссылка скопирована в буфер обмена!');
      }).catch(err => {
        console.error('Ошибка копирования: ', err);
        alert('Не удалось скопировать ссылку');
      });
    };

    // Функции для социальных сетей
    const pageUrl = encodeURIComponent(window.location.href);
    const pageTitle = encodeURIComponent(document.title);

    window.shareToFacebook = function() {
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${pageUrl}`, '_blank');
    };

    window.shareToVK = function() {
      window.open(`https://vk.com/share.php?url=${pageUrl}&title=${pageTitle}`, '_blank');
    };

    window.shareToTelegram = function() {
      window.open(`https://t.me/share/url?url=${pageUrl}&text=${pageTitle}`, '_blank');
    };
  });
</script>

{% endblock %}